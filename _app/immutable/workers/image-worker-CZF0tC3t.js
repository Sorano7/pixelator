(function(){"use strict";function D(M,r,s,u,e,o=8){const{width:l,height:d,data:p}=M,n=new ImageData(new Uint8ClampedArray(p),l,d);if(u){const a=S(n,e,o);P(n,a)}return r&&C(n,s),n}function S(M,r,s=8){const{width:u,height:e,data:o}=M,l=u*e;r=Math.max(1,Math.min(r,256));const p=Math.max(1,Math.floor(l/5e3)),n=[];for(let f=0;f<l;f+=p){const c=f*4,h=o[c],t=o[c+1],i=o[c+2];n.push([h,t,i])}if(n.length===0)return[[0,0,0]];const a=[];for(let f=0;f<r;f++){const c=n[Math.floor(Math.random()*n.length)];a.push([c[0],c[1],c[2]])}const b=new Array(n.length).fill(0);for(let f=0;f<s;f++){for(let t=0;t<n.length;t++){const i=n[t];let g=0,x=1/0;for(let m=0;m<a.length;m++){const w=a[m],y=i[0]-w[0],I=i[1]-w[1],z=i[2]-w[2],A=y*y+I*I+z*z;A<x&&(x=A,g=m)}b[t]=g}const c=Array.from({length:r},()=>[0,0,0]),h=new Array(r).fill(0);for(let t=0;t<n.length;t++){const i=b[t],g=n[t];c[i][0]+=g[0],c[i][1]+=g[1],c[i][2]+=g[2],h[i]+=1}for(let t=0;t<r;t++)if(h[t]>0)a[t][0]=Math.round(c[t][0]/h[t]),a[t][1]=Math.round(c[t][1]/h[t]),a[t][2]=Math.round(c[t][2]/h[t]);else{const i=n[Math.floor(Math.random()*n.length)];a[t]=[i[0],i[1],i[2]]}}return a}function P(M,r){const{data:s}=M,u=s.length/4;for(let e=0;e<u;e++){const o=e*4,l=s[o],d=s[o+1],p=s[o+2];let n=0,a=1/0;for(let h=0;h<r.length;h++){const[t,i,g]=r[h],x=l-t,m=d-i,w=p-g,y=x*x+m*m+w*w;y<a&&(a=y,n=h)}const[b,f,c]=r[n];s[o]=b,s[o+1]=f,s[o+2]=c}}function C(M,r){const{width:s,height:u,data:e}=M,o=Math.max(1,Math.floor(r));for(let l=0;l<u;l+=o)for(let d=0;d<s;d+=o){const p=Math.min(d+Math.floor(o/2),s-1),a=(Math.min(l+Math.floor(o/2),u-1)*s+p)*4,b=e[a],f=e[a+1],c=e[a+2],h=e[a+3],t=Math.min(l+o,u),i=Math.min(d+o,s);for(let g=l;g<t;g++)for(let x=d;x<i;x++){const m=(g*s+x)*4;e[m]=b,e[m+1]=f,e[m+2]=c,e[m+3]=h}}}self.onmessage=M=>{const{width:r,height:s,data:u,doPixelate:e,blockSize:o,doQuantize:l,paletteSize:d}=M.data,p=new ImageData(new Uint8ClampedArray(u),r,s),n=D(p,e,o,l,d);self.postMessage({width:n.width,height:n.height,buffer:n.data.buffer})}})();
